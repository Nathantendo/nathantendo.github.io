<!DOCTYPE html>
<html>
<head>
    <title>Simple Audio Extractor</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
        #drop-zone { border: 2px dashed #bbb; padding: 40px; border-radius: 20px; background: white; cursor: pointer; }
        #status { margin-top: 20px; color: #555; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none; margin: 20px auto; }
    </style>
</head>
<body>

    <h2>Video to Audio (WAV)</h2>
    <div id="drop-zone">Click to select MP4 from S24</div>
    <input type="file" id="file-input" accept="video/*" style="display:none">
    
    <div id="status">Ready.</div>
    <button id="download-btn">Download Audio</button>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const status = document.getElementById('status');
        const downloadBtn = document.getElementById('download-btn');

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "Processing audio... please wait.";
            
            const arrayBuffer = await file.arrayBuffer();
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            try {
                // Decode the video's audio track
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                
                // Convert buffer to WAV blob
                const wavBlob = bufferToWave(audioBuffer, audioBuffer.length);
                const url = URL.createObjectURL(wavBlob);
                
                status.innerText = "Conversion Finished!";
                downloadBtn.style.display = "block";
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.replace(/\.[^/.]+$/, "") + ".wav";
                    a.click();
                };
            } catch (err) {
                status.innerText = "Error: Use a standard MP4 file.";
                console.error(err);
            }
        };

        // Helper function to create the WAV file structure
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            setUint32(0x46464952);                         
            setUint32(length - 8);                         
            setUint32(0x45564157);                         
            setUint32(0x20746d66);                         
            setUint32(16);                                 
            setUint16(1);                                  
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); 
            setUint16(numOfChan * 2);                      
            setUint16(16);                                 
            setUint32(0x61746164);                         
            setUint32(length - pos - 4);                   

            for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

            while(pos < length) {
                for(i = 0; i < numOfChan; i++) {             
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; 
                    view.setInt16(pos, sample, true);          
                    pos += 2;
                }
                offset++;                                     
            }

            return new Blob([buffer], {type: "audio/wav"});

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
        }
    </script>
</body>
</html>
